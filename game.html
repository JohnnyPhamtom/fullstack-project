<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html"; charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=0" />

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.7.0/animate.min.css">

    <link href='https://fonts.googleapis.com/css?family=Shadows Into Light Two' rel='stylesheet'>
    <link href='https://fonts.googleapis.com/css?family=Handlee' rel='stylesheet'>
    <link href='https://fonts.googleapis.com/css?family=Courgette' rel='stylesheet'>
    <link href='https://fonts.googleapis.com/css?family=Kalam' rel='stylesheet'>

    <script type="text/javascript" src="http://localhost:3000/socket.io/socket.io.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/socket.io-client/dist/socket.io.slim.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue-socket.io-extended"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.22.0/moment.min.js"></script>

    <title>The game of things</title>

    <style>
      html, body {
        min-height: 100%;
        padding: 0px;
        margin: 0px;
        height: 100%;
        width: 100%;
        overflow: hidden;
      }

      
      #app {
        border: none;
        position: absolute;
        right: 1px;
        width: 100%;
        height: 100%;
      }
    

      #main-panel {
        /* border: solid; */
        position: absolute;
        right: 1px;
        width: 70%;
        height: 100%;
      }

      #status-panel {
        /* border: solid; */
        position: absolute;
        left: 0px;
        width: 29%;
        height: 100%;
      }

      #control-panel {
        position: absolute;
        border-left: solid;
        border-top: solid;
        border-right: solid;
        bottom: 0px;
        width: 100%;
        height: 25%;
        /*background-image: url('https://storage.googleapis.com/studydsstore/1552258880202bg_alternative1.jpg');
        background-size: cover; */
      }

      player-in-room {
        width: 100%;
      }

      #players-in-room {
        position: absolute;
        border-bottom: solid;
        border-right: solid;
        width: 100%;
        height: 35%;
        top: 0px;
        left: 0px;
      }

      #players-list {
        padding: 0px;
        left: 50%;
      }

      #players-list div {
        margin-bottom: 2px;
      }

      #current-player-info-container {
        position: absolute;
        top: 36%;
        left: 0px;
        width: 100%;
        height: 20%;
        border-bottom: solid;
        border-top: solid;
        border-right: solid;
      }

      #current-player-info-avatar-container {
        position: absolute;
        left: 5px;
        height: 95%;
        top: 2%;
        width: 50%;
        border: 1px solid black;
        border-radius: 10px;
      }

      #current-player-info-avatar-img {
        height: 100%;
        width: 100%;
        object-fit: contain;
      }

      #current-player-info-text-container {
        position: absolute;
        right: 0px;
        top: 0px;
        width: 46%;
        height: 98%;
      }

      #current-player-info-text-username {
        position: absolute;
        width: 100%;
        height: 32%;
        top: 0px;
        left: 0px;
        font-size: 20px;
        font-family: 'Handlee';
        font-weight: bold;
        padding-left: 1%;
        padding-top: 5%;
      }

      #current-player-info-text-points {
        position: absolute;
        width: 100%;
        height: 32%;
        top: 33%;
        left: 0px;
        font-size: 20px;
        font-family: 'Handlee';
        font-weight: bold;
        padding-left: 1%;
        padding-top: 5%;
      }

      #current-player-info-text-ready-button {
        position: absolute;
        width: 100%;
        height: 32%;
        top: 66%;
        left: 0px;
      }

      #current-player-ready-button {
        width: 80%;
        height: 80%;
        position: absolute;
        left: 5%;
        top: 10%;
        border: 2px solid black;
        border-radius: 10px;
      }

      #current-player-ready-button span {
        display: block;
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 20px;
        font-family: 'Handlee';
        font-weight: bold;
      }

      #current-player-ready-button:hover {
        border: 3px solid black;
        border-radius: 10px; 
      }

      #current-card-info-container {
        position: absolute;
        top: 57.5%;
        height: 13.5%;
        left: 0px;
        width: 96%;
        border-bottom: solid;
        border-top: solid;
        border-right: solid;
        font-size: 20px;
        font-family: 'Handlee';
        padding-top: 3%;
        padding-left: 4%;
      }

      #current-card-info-container span {
        font-size: 25px;
        font-family: 'Handlee';  
      }

      #message-log-container {
        position: absolute;
        top: 74.5%;
        left: 0px;
        width: 100%;
        height: 25%;
        border-top: solid;
        border-right: solid; 
        overflow-y: scroll;
      }

      #cards {
        list-style-type: none; 
        margin: 0; 
        padding: 0;
      }

      #cards li { 
        padding: 5px 10px; 
      }

      .card-container {
        position: relative;
        border: solid;
        height: 50px;
        width: 200px;
        margin-bottom: 2px;
      }

      /* Container for two lists */
      .lists-container {
        position: absolute;
        top: 0px;
        left: 0px;
        width: 100%;
        height: 73.5%;
        margin: 0%;
        overflow: hidden;
        border-bottom: solid;
        border-left: solid;
      }

      /* Container for avatar list */
      .avatar-list-container {
        position: absolute;
        /* border: solid; */
        left: 15%;
        width: 20%;
        height: 100%;
        top: 0px;
        overflow: hidden;
      }

      /* Container for answer list */
      .answer-list-container {
        position: absolute;
        /* border: solid; */
        width: 40%;
        height: 100%;
        top: 0px;
        left: 40%;
        overflow: hidden;
      }

      #answers, #avatars {
        height: 100%;
        width: 100%;
        padding: 0px;
        margin: 0px;
      }

      #avatars > div {
        /* border: solid; */
        width: 99%;
        height: 24%;
        margin-left: 1px;
        z-index: 1;
      }

      #answers > div {
        position: relative;
        width: 100%;
        height: 24%;
        margin-left: 1px;
        padding-left: 2%;
        z-index: 1;
      }

      .card-border {
        width: 100%;
        height: 90%;
        object-fit: scale-down;
      }

      .avatar-image {
        width: 80%;
        height: 70%;
        margin-left: 20%;
        object-fit: contain;
        margin-bottom: 0px;
      }

      .username-container {
        width: 80%;
        height: 5%;
        padding: 0px;
        margin-left: 20%;
        margin-top: 0px;
        font-size: 20px;
        text-align: center;
        font-family: 'Handlee';
        font-weight: bold;
        position: absolute;
      }

      .avatar-image-container {
        left: 20%;
        width: 60%;
        position: absolute;
      }

      .answer-text-container {
        top: 30%;
        left: 25%;
        width: 47%;
        height: 35%;
        font-family: 'Shadows Into Light Two';
        font-size: 25px;
        text-decoration: underline;
        text-align: center;
        position: absolute;
      }

      #input-form-container {
        left: 10%;
        top: 1%;
        width: 60%;
        height: 69%;
        position: absolute;
        font-size: 25px;
        font-family: 'Courgette';
        text-align: center;
      }

      #answer-user-input {
        font-family: 'Handlee';
        font-size: 30px;
        font-style: italic;
        text-decoration: underline;
      }

      #answer-input-container {
        position: absolute;
        width: 100%;
        height: 15%;
        bottom: 0px;
      }

      #answer-input-text-area {
        width: 85%;
        height: 100%;
        bottom: 0px;
        position: absolute;
      }

      input#answer-input-text-area {
        font-size: 23px;
        font-family: 'Handlee';
      }

      #answer-input-enter-button {
        width: 14%;
        height: 100%;
        margin: 0px;
        border: 2px solid black;
        position: absolute;
        right: 0px;
        bottom: 0.5px;
        text-align: center;
        font-size: 23px;
        font-family: 'Handlee';
      }

      #answer-input-enter-button:hover {
        cursor: pointer;
        border: 3px solid black;
      }

      #guess-form-prompt-container {
        left: 5%;
        top: 1px;
        width: 70%;
        height: 18%;
        position: absolute;
        font-size: 20px;
        font-family: 'Kalam';
        text-align: center;
      }

      #guess-form-container {
        left: 10%;
        top: 20%;
        width: 60%;
        height: 69%;
        position: absolute;
        font-size: 30px;
        font-family: 'Courgette';
        text-align: center;
      }

      #guess-form-container #guess-form-username {
        font-family: 'Kalam';
        font-size: 40px;
        font-weight: bold;
      }

      #guess-form-container #guess-form-useranswer {
        font-weight: bold;
        text-decoration: underline;
        font-family: 'Kalam';
        font-size: 40px;
      }

      #guess-form-button {
        left: 75%;
        top: 35%;
        height: 20%;
        width: 10%;
        position: absolute;
        display: block;
        border: solid 2px;
        border-radius: 20px;
        font-size: 25px;
        font-family: 'Courgette';
        font-weight: bold;
        background-color: white;
        overflow: hidden;
      }

      #guess-form-button:hover {
        border: solid 3px;
      }

      .out-of-round-text-container {
        left: 20%;
        top: 30%;
        width: 60%;
        height: 69%;
        position: absolute;
        font-size: 40px;
        font-family: 'Courgette';
        font-weight: bold;
        text-align: center;
        text-decoration: underline;
      }

      #observe-form-container {
        left: 20%;
        top: 30%;
        width: 60%;
        height: 69%;
        position: absolute;
        font-size: 30px;
        font-family: 'Courgette';
        text-align: center;
      }

      .flip-list-move {
        transition: transform 1s;
      } 

      .flip-list-enter-active, .flip-list-leave-active {
        transition: all 1s;
      }
      
      .flip-list-enter, .flip-list-leave-to {
        /* .flip-list-leave-active below version 2.1.8 */ 
        opacity: 0;
        transform: translateY(30px);
      }

      .component-fade-enter-active, .component-fade-leave-active {
        transition: opacity .5s ease;
      }
      
      .component-fade-enter, .component-fade-leave-to {
        /* .component-fade-leave-active below version 2.1.8 */ 
        opacity: .0;
      }

      .player-info {
        border: solid;
        width: 80%;
        padding-left: 20px;
        margin-left: 10px; 
      }

      #ready-button {
        z-index: 3;
      }

      .guess-pointer {
        cursor: pointer;
      }

      #message-log-container ul#messages {
        padding-left: 5px;
      }

      #message-log-container ul#messages > p{
        margin-left: 3px;
      }

      .message-time {
        font-size: 15px;
        font-family: 'Handlee';
        font-weight: bold;
      }

      .message-content {
        font-size: 20px;
        font-family: 'Handlee';
      }
    </style>
  </head>
  <body>
    <div id="app">
      <div id="status-panel">
        <players-in-room
          v-bind:players="playersInRoom"></players-in-room>
        <div id="current-player-info-container">
          <div id="current-player-info-avatar-container">
            <img id="current-player-info-avatar-img" v-bind:src="currentPlayer.avatarUrl">
          </div>
          <div id="current-player-info-text-container">
            <div id="current-player-info-text-username">
              Name: {{ currentPlayer.username }}
            </div>
            <div id="current-player-info-text-points">
              Points: {{ currentPlayer.points }}
            </div>
            <div id="current-player-info-text-ready-button">
              <p>
                <div
                  id="current-player-ready-button"
                  v-on:click="currentPlayerReady"><span>Ready</span></div> 
              </p>
            </div>
          </div>
        </div>
        <div id="current-card-info-container">
          Current card question:<br>
          <span style="text-align:center">{{ currentCard }}</span>
        </div>
        <div id="message-log-container">
          <ul id="messages">
            <p v-for="message in messageLog">
              <span class="message-time">[ {{message.time}} ]</span>
              &nbsp;&nbsp;
              <span class="message-content">{{ message.message }}</span>
            </p>
          </ul>
        </div>
      </div>

      <div id="main-panel">
        <transition name="component-fade" mode="out-in">
          <component
            v-bind:is="displayMode"
            v-bind:current-player="currentPlayer"
            v-bind:users="submittedUsers"
            v-bind:answers="submittedAnswers"
            v-bind:cards="submittedCards"></component>
        </transition>

        <div id="control-panel">
          <component
            v-bind:is="inputMode"
            v-bind:guess="guessedResult"
            v-bind:current-player="currentPlayer"
            v-bind:key="currentPlayer.username"
            v-bind:msg="observeMsg"
            v-bind:guess-form-msg="currentGuessFormPromptMsg"
            v-on:submit-answer="submitAnswer"
            v-on:submit-guessed-match="submitGuessedMatch"></component>

          <button
            v-for="mode in gameModes"
            v-bind:key="mode"
            v-on:click="gameModeTransition(mode)">{{ mode }}</button>  
          </div>
      </div>
    </div>
  </body>
  <script type="text/javascript">
    // The components for the out-of-round stage:
    // - avatar list          "avatar-list"
    // - answer list          "answer-list"
    // - card display window  "card-window"
    // - out of round status bar  "out-of-round-form"
    Vue.component('avatar-list', {
      props: ['avatar'],
      template: '\
        <div>\
          <img class="avatar-image" v-bind:src="avatar.avatarUrl">\
          <div class="username-container">\
            {{ avatar.username }}\
          </div>\
        </div>\
      '
    });

    Vue.component('answer-list', {
      props: ['answer'],
      template: '\
        <div>\
          <img class="card-border" src="https://storage.googleapis.com/studydsstore/1552259284708rectangle_box.jpg">\
          <div class="answer-text-container">\
            {{ answer.useranswer }}\
          </div>\
        </div>\
      '
    });

    Vue.component('out-of-round-form', {
      props: [],
      template: '\
        <div class="out-of-round-form">\
          <div class="out-of-round-text-container">\
            You\'re out of round!\
          </div>\
        </div>\
      '
    });

    Vue.component('card-window', {
      props: ['cards'],
      template: '\
        <div class="lists-container">\
        \
          <div class="avatar-list-container">\
            <ul id="avatars">\
              <avatar-list\
                v-for="card in cards"\
                v-bind:avatar="card"\
              ></avatar-list>\
            </ul>\
          </div>\
        \
          <div class="answer-list-container">\
            <ul id="answers">\
              <answer-list\
                v-for="card in cards"\
                v-bind:answer="card"\
              ></answer-list>\
            </ul>\
          </div>\
        \
        </div>\
      ',
    });


    // The components for the guessing stage:
    // - avatar list          "guess-avatar-list"
    // - answer list          "guess-answer-list"
    // - answer input form    "guess-form"
    // - card display window  "guess-window"
    Vue.component('guess-avatar-list', {
      props: ['avatar'],
      template: '\
        <div\
          v-bind:class="{animated: isActive, bounce: isOtherPlayer, shake: isCurrentPlayer, \'guess-pointer\': isActive}"\>\
          <img\
            v-on:click="globalEmitUsernameSelected"\
            v-on:mouseenter="activeAnimation"\
            v-on:mouseleave="disableAnimation"\
            class="avatar-image" v-bind:src="avatar.avatarUrl">\
          <div class="username-container">\
            {{ avatar.username }}\
          </div>\
        </div>\
      ',
      data: function() {
        return {
          isActive: false,
          username: this.avatar,
        }
      },
      methods: {
        globalEmitUsernameSelected: function() {
          if(this.avatar.username != this.$root.currentPlayer.username) {
            this.$root.guessedResult.username = this.avatar.username;
          } 
        },
        activeAnimation: function() {
          this.isActive = true;
        },
        disableAnimation: function() {
          this.isActive = false;
        }
      },
      computed: {
        isCurrentPlayer: function() {
          if(this.avatar.username == this.$root.currentPlayer.username) {
            return (true && this.isActive);
          } else {
            return false;
          }
        },
        isOtherPlayer: function() {
          if(this.avatar.username != this.$root.currentPlayer.username) {
            return (true && this.isActive);
          } else {
            return false;
          }
        }
      }
    });

    Vue.component('guess-answer-list', {
      props: ['answer'],
      template: '\
        <div\
          v-on:click="globalEmitAnswerSelected"\
          v-on:mouseenter="activeAnimation"\
          v-on:mouseleave="disableAnimation"\
          v-bind:class="{animated: isActive, swing: isActive, \'guess-pointer\': isActive}">\
          <img\
            v-on:click="globalEmitAnswerSelected"\
            class="card-border" src="https://storage.googleapis.com/studydsstore/1552259284708rectangle_box.jpg">\
          <div class="answer-text-container">\
            {{ answer.useranswer }}\
          </div>\
        </div>\
      ',
      data: function() {
        return {
          isActive: false,
          useranswer: this.answer
        }
      },
      methods: {
        globalEmitAnswerSelected: function() {
          this.$root.guessedResult.useranswer = this.answer.useranswer;
          // EventBus.$emit('guessed-answer', this.answer);
        },
        activeAnimation: function() {
          this.isActive = true;
        },
        disableAnimation: function() {
          this.isActive = false;
        }
      }
    });

    Vue.component('guess-form', {
      props: ['guess', 'guessFormMsg'],
      template: '\
        <div>\
          <div id="guess-form-prompt-container">\
            <span id="selected-self">{{ prompt }}</span>\
          </div>\
          <div id="guess-form-container">\
            <p id="guess-form-text">\
              <span>\
                <span id="guess-form-username">\
                  {{ guess.username }}\
                </span>\
                said&nbsp\
                <span id="guess-form-useranswer">\
                  {{ guess.useranswer }}\
                </span>\
              </span>\
            </p>\
          </div>\
          <div\
            v-on:click="submitGuessedMatchHandler"\
            id="guess-form-button">&nbsp Match</div>\
        </div>\
      ',
      data: function() {
        return {
          prompt: '',
        }
      },
      methods: {
        submitGuessedMatchHandler: function() {
          if(this.guess.username == '' || this.guess.username == undefined) {
            // do something
            this.prompt = "You must choose a player!";
            setTimeout(this.clearPrompt, 1000);
          } else {
            this.$emit('submit-guessed-match');
          }
        },
        clearPrompt: function() {
          this.prompt = '';
        }
      }
    });

    Vue.component('guess-window', {
      props: ['users', 'answers'],
      template: '\
        <div class="lists-container">\
        \
          <div class="avatar-list-container">\
            <transition-group name=\"flip-list\" tag=\"ul\" id="avatars">\
                <guess-avatar-list\
                  v-for="user in users"\
                  v-bind:avatar="user"\
                  v-bind:key="user.username"\
                ></guess-avatar-list>\
            </transition-group>\
          </div>\
        \
          <div class="answer-list-container">\
            <transition-group name=\"flip-list\" tag=\"ul\" id="answers">\
              <guess-answer-list\
                v-for="answer in answers"\
                v-bind:answer="answer"\
                v-bind:key="answer.useranswer"\
              ></guess-answer-list>\
            </transition-group>\
          </div>\
        \
        </div>\
      ',
    });


    // The components for the answering stage
    // - avatar list          "avatar-list"
    // - answer list          "invisible-answer-list"
    // - card display window  "answer-window"
    // - answer input form    "input-form"
    Vue.component('invisible-answer-list', {
      props: ['card', 'current-player'],
      template: '\
        <div>\
          <img class="card-border" src="https://storage.googleapis.com/studydsstore/1552259284708rectangle_box.jpg">\
          <div class="answer-text-container">\
            {{ displayedAnswer }}\
          </div>\
        </div>\
      ',
      computed: {
        displayedAnswer: function() {
          // console.log(this.card);
          return this.card.username == this.currentPlayer.username 
            ? this.card.useranswer : '?';
        }
      }
    });

    Vue.component('answer-window', {
      props: ['cards', 'current-player'],
      template: '\
        <div class="lists-container">\
        \
          <div class="avatar-list-container">\
            <ul id="avatars">\
              <avatar-list\
                v-for="card in cards"\
                v-bind:avatar="card"\
              ></avatar-list>\
            </ul>\
          </div>\
        \
          <div class="answer-list-container">\
            <ul id="answers">\
              <invisible-answer-list\
                v-for="card in cards"\
                v-bind:card="card"\
                v-bind:current-player="currentPlayer"\
              ></invisible-answer-list>\
            </ul>\
          </div>\
        \
        </div>\
      ',
    });

    //  <input id=\"username-input\" v-model=\"user.username\">\

    Vue.component('input-form', {
      props: ['input_msg', 'current-player'],
      template: '\
        <div>\
          <div id="input-form-container">\
            <br>\
            <p>\
              {{ currentPlayer.username }}\'s answer for the question is\
              <span id="answer-user-input">{{ user.userinput }}</span>\
            </p>\
          </div>\
          <div id="answer-input-container">\
            <input id=\"answer-input-text-area\" v-model=\"user.userinput\">\
            <div\
              id="answer-input-enter-button"\
              v-on:click=\"$emit(\'submit-answer\', user)\">\
              Enter\
            </div>\
          </div>\
        </div>\
      ',
      data: function() {
        return {
          user: {
            username: this.currentPlayer.username,
            avatarUrl: this.currentPlayer.avatarUrl,
            userinput: ''
          }
        };
      }
    });


    // The components for the left status panel
    Vue.component('player-info', {
      props: ['player'],
      template: '\
        <div class="player-info">\
          <p>\
            Player: {{ player.username }}\
            <span v-if="player.ready == \'true\'">\
              ready!\
            </span>\
            <span v-else>\
              Wait...\
            </span>\
          </p>\
        </div>\
      '
    });

    Vue.component('players-in-room', {
      props: ['players'],
      template: '\
        <div id="players-in-room">\
          <ul id="players-list">\
            <player-info\
              v-for="p in players"\
              v-bind:player="p"\
            ></player-info>\
          </ul>\
        </div>\
      '
    });


    // The components for waiting stage
    Vue.component('waiting-window', {
      props: [],
      template: '\
        <div id="waiting">\
        </div>\
      '
    });

    Vue.component('observe-form', {
      props: ['msg'],
      template: '\
        <div id="observe-form">\
          <div id="observe-form-container">\
            {{ msg }}\
          </div>\
        </div>\
      '
    });

    Vue.component('observe-wait-form', {
      props: ['msg'],
      template: '\
        <div id="observe-form">\
          <div id="observe-form-container">\
            <span>{{ msg[0] }}</span>\
            <span style="text-decoration: underline">\
              {{ msg[1] }}\
            </span>\
            <span>{{ msg[2] }}</span>\
          </div>\
        </div>\
      ',
    });

    Vue.component('observe-answer-form', {
      props: ['msg'],
      template: '\
        <div id="observe-form">\
          <div id="observe-form-container">\
            <span>{{ msg[0] }}</span>\
            <span style="text-decoration: underline">\
              {{ msg[1] }}\
            </span>\
            <span>{{ msg[2] }}</span>\
          </div>\
        </div>\
      '
    });



    // The event bus handling the global page's events 
    const EventBus = new Vue();

    // vue-socket.io-extended set up
    Vue.use(VueSocketIOExt, io('http://localhost:3000'));

    // The top level component: app
    let app = new Vue({
      el: '#app',
      data: {
        roomId: undefined,
        // current player
        currentPlayer: {
          // assume that the players are identified by their names
          username: '', 
          avatarUrl: '',
          userId: undefined,
          points: 0,
        },
        firstTime: true,
        currentPlayerAnswered: false,
        currentCard: '',
        // the players' info in current room
        playersInRoom: [
          // an array of player objects
          /*{
            username: 'player1',
            avatarUrl: 'https://storage.googleapis.com/studydsstore/1552259322551avatar1.jpg',
            ready: false
          },
          {
            username: 'player2',
            avatarUrl: 'https://storage.googleapis.com/studydsstore/1552259322551avatar1.jpg',
            ready: false
          },
          {
            username: 'player3',
            avatarUrl: 'https://storage.googleapis.com/studydsstore/1552259322551avatar1.jpg',
            ready: false
          },*/
        ],
        // the user infos for having submitted answer
        submittedCards: [
          /*{
            username: 'player1',
            useranswer: 'answer1',
            avatarUrl: 'https://storage.googleapis.com/studydsstore/1552259322551avatar1.jpg',
          },
          {
            username: 'player2',
            useranswer: 'answer2',
            avatarUrl: 'https://storage.googleapis.com/studydsstore/1552259322551avatar1.jpg',
          },
          {
            username: 'player3',
            useranswer: 'answer3',
            avatarUrl: 'https://storage.googleapis.com/studydsstore/1552259322551avatar1.jpg',
          },*/
        ],
        // separated two lists for shuffling in guessing stage
        submittedUsers: [
          /*{
            username: 'player1',
            avatarUrl: 'https://storage.googleapis.com/studydsstore/1552259322551avatar1.jpg',
          },
          {
            username: 'player2',
            avatarUrl: 'https://storage.googleapis.com/studydsstore/1552259322551avatar1.jpg',
          },
          {
            username: 'player3',
            avatarUrl: 'https://storage.googleapis.com/studydsstore/1552259322551avatar1.jpg',
          },*/
        ],
        // the answers of the users
        submittedAnswers: [
          /*{useranswer: 'answer1'},
          {useranswer: 'answer2'},
          {useranswer: 'answer3'},*/
        ],
        // current mode of the game, default (initial) is "wait"
        currentGameMode: 'wait',
        // game mode: currently there are two: answering and guessing
        gameModes: [
          'wait',
          'answer',
          'guess',
          'observe answer',
          'observe guess',
          'out of round'
        ],
        // the results of the guessing (name matches answer)
        guessedResult: {
          username: '',
          useranswer: '',
        },
        input_msg: '',
        messageLog: [],
      },
      methods: {
        // submitAnswer shall be triggered by player clicking "enter" button
        // "answer" event is emitted to backend, with an String:
        //   answer: ...    the answer of the current client 
        submitAnswer: function(answer) {
          console.log(answer.username + '......' + answer.userinput);

          this.messageLog.unshift({
            message: `You have submitted the answer`,
            time: moment().format('h:mm:ss a')
          });

          this.submittedUsers.push({
            username: answer.username,
            avatarUrl: answer.avatarUrl
          });
          this.submittedAnswers.push({useranswer: answer.userinput});
          this.submittedCards.push({
            username: answer.username,
            useranswer: answer.userinput,
            avatarUrl: answer.avatarUrl
          });

          this.currentPlayerAnswered = true;

          this.currentGameMode = 'observe answer';
          
          this.$socket.emit('answer', answer.userinput);
        },
        // submitGuessedMatch shall be triggered when current player confirm its match
        // "guessMatch" or "guessMismatch" is emitted to backend, with an object:
        // {
        //   username: ...          the name of current player (guesser)
        //   userId: ...            the sessionId of current player (guesser)
        //   matchedUser: ...       the guesser selected user name
        //   matchedUserAnswer: ... the guesser selected useranswer
        //   roomId: ...            the room ID
        // }
        // "guessMatch" and "guessMismatch" emitted with the same object like above
        // Assume that backend recognizes its difference by event name
        submitGuessedMatch: function() {
          let username = this.guessedResult.username;
          let useranswer = this.guessedResult.useranswer;
          let removedSubmittedCards = [];
          let matched = false;

          console.log(this.guessedResult);

          this.submittedCards = this.submittedCards.filter(function(card) {
            if((card.username !== username) || (card.useranswer !== useranswer)) {
              return true;
            } else {
              matched = true;
              return false;
            }
          });

          if(matched) {
            this.submittedUsers = this.submittedUsers.filter(function(card) {
              return card.username !== username;
            });

            let hasRemoved = false;
            this.submittedAnswers = this.submittedAnswers.filter(function(card) {
              if(!hasRemoved && card.useranswer === useranswer) {
                hasRemoved = true;
                return false;
              } else {
                return true;
              }
            });

            this.currentPlayer.points += 1;

            this.messageLog.unshift({
              message: `You guessed correctly and got another turn`,
              time: moment().format('h:mm:ss a')
            });
            
            this.$socket.emit('guessMatch', { // assume usernames are unique
              username: this.currentPlayer.username,  // current player (name) guessed correctly
              userId: this.currentPlayer.userId,  // current player (ID) guessed correctly
              matchedUsername: username,      // the correct username
              matchedUserAnswer: useranswer,  // the correct answer
              roomId: this.roomId
            });
          } else {
            console.log('mismatch');
            this.messageLog.unshift({
              message: `You guessed incorrectly and gave turn to other`,
              time: moment().format('h:mm:ss a')
            });

            const node1 = document.querySelector('#guess-form-text');
            const node2 = document.querySelector('#guess-form-button');
            node1.classList.add('animated', 'tada');
            node2.classList.add('animated', 'tada');

            function handleAnimationEnd() {
              node1.classList.remove('animated', 'tada');
              node1.removeEventListener('animationend', handleAnimationEnd);
              node2.classList.remove('animated', 'tada');
              node2.removeEventListener('animationend', handleAnimationEnd);
            }

            node1.addEventListener('animationend', handleAnimationEnd);
            node2.addEventListener('animationend', handleAnimationEnd);
            
            setTimeout(function() {
              app.$socket.emit('guessMismatch', {
                username: app.currentPlayer.username,  // current player (name) guessed wrong
                userId: app.currentPlayer.userId,  // current player (ID) guessed wrong
                matchedUsername: username,      // the wrong username
                matchedUserAnswer: useranswer,  // the wrong answer
                roomId: app.roomId 
              });
            }, 1000);
          }
        },
        gameModeTransition: function(mode) {
          if(mode === 'guess') {
            this.shuffle();
          }
          this.currentGameMode = mode;
        },
        shuffle: function() {
          for(let ii = this.submittedAnswers.length - 1; ii > 0; ii--) {
            let randomIndex = Math.floor(Math.random() * ii);

            let temp = this.submittedAnswers[ii];
            Vue.set(this.submittedAnswers, ii, this.submittedAnswers[randomIndex]);
            Vue.set(this.submittedAnswers, randomIndex, temp);
          }
        },
        // currentPlayerReady is triggered when player click button "ready"
        // "playerStateReady" event is emitted to backend, with an object:
        // {
        //   roomId: ...
        //   username: ...
        //   userId: ...   the sessionId of the client
        // }
        currentPlayerReady: function() {
          this.messageLog.unshift({
            message: `You are ready`,
            time: moment().format('h:mm:ss a')
          });

          this.$socket.emit('playerStateReady', {
            roomId: this.roomId,
            username: this.currentPlayer.username,
            userId: this.currentPlayer.userId
          });

          for(let ii = 0; ii < this.playersInRoom.length; ++ii) {
            if(this.playersInRoom[ii].username === this.currentPlayer.username) {
              this.playersInRoom[ii].ready = 'true';
              break;
            }
          }
        }
      },
      computed: {
        inputMode: function() {
          switch(this.currentGameMode) {
            case 'answer': 
              return 'input-form';
            case 'guess':
              return 'guess-form';
            case 'out of round':
              return 'out-of-round-form';
            case 'wait':
              return 'observe-wait-form';
            case 'observe answer': 
              return 'observe-answer-form';
            case 'observe guess':
              return 'observe-form';
            default: 
              return 'unknown: currentGameMode error';
          }
        },
        displayMode: function() {
          switch(this.currentGameMode) {
            case 'answer': 
              return 'answer-window';
            case 'guess':
              return 'guess-window';
            case 'out of round':
              return 'card-window';
            case 'wait':
              return 'waiting-window';
            case 'observe answer':
              return 'answer-window';
            case 'observe guess':
              return 'answer-window';
            default: 
              return 'unknown: currentGameMode error';
          }
        },
        observeMsg: function() {
          switch(this.currentGameMode) {
            case 'observe answer': {
              let strUnsubmittedPlayers = [];

              this.playersInRoom.forEach(function(player) {
                let submitted = false;
                for(let ii = 0; ii < app.submittedUsers.length; ++ii) {
                  if(player.username == app.submittedUsers[ii].username) {
                    submitted = true;
                    break;
                  }
                }
                if(!submitted) {
                  strUnsubmittedPlayers.push(player.username);
                }
              });
              strUnsubmittedPlayers = 
                strUnsubmittedPlayers.length === 0 
                  ? ''
                  : strUnsubmittedPlayers.join(' ,');

              return strUnsubmittedPlayers.length === 0 
                ? ['Please wait server\'s response ...', '', ''] 
                : ['Please wait for', 
                    strUnsubmittedPlayers, 
                    'finish answering the card'
                  ];
            }
          
            case 'observe guess': 
              return 'Currently it\'s not your turn to guess a match';

            case 'wait': {
              let strUnreadyPlayers = [];

              this.playersInRoom.forEach(function(player) {
                if(player.ready === 'false') {
                  strUnreadyPlayers.push(player.username);
                }
              });
              strUnreadyPlayers = strUnreadyPlayers.join(' ,'); 

              return ['Game will start after', strUnreadyPlayers, 'click "ready"'];
            }
          }
        },
      },
      // handle all the events sent from server side
      // Currently handle following events:
      //  - playerJoin
      //  - playerLeave
      //  - answer
      //  - playerOut
      //  - guessMatch
      //  - playerTurn
      //  - newRound
      // 
      // Following events can be received, but still need Vue components 
      // to handle those events:
      //  - gameStateWait    ==> prompt window to inform player
      //  - gameStateAnswer  ==> prompt window to inform player
      //  - gameStateGuess   ==> prompt window to inform player
      //  - gameStateEnd     ==> prompt window to inform player
      //  - playerStateReady ==> An status bar after player' info to show that 
      //                         this player is ready 
      sockets: {
        playerJoin: function(data) {
          console.log(data.playerList);
          
          // let currentPlayerAvatarUrl = '';
          if(this.firstTime) {
            for(let ii = 0; ii < data.playerList.length; ++ii) {
              this.playersInRoom.push({
                username: data.playerList[ii].username,
                avatarUrl: data.playerList[ii].avatar,
                ready: data.playerList[ii].ready === true ? 'true' : 'false'
              });
            }
            this.firstTime = false; 
          }

          console.log(`received from server playerJoin:  
            ${data.username}    ${data.roomId}`);

          this.messageLog.unshift({
            message: `${data.username} enter into the room`,
            time: moment().format('h:mm:ss a')
          });

          if(this.roomId === undefined) {
            this.roomId = data.roomId;
          }

          if(this.currentPlayer.userId === undefined || 
             this.currentPlayer.userId === '') {
            if(data.username !== undefined && data.roomId !== undefined) {
              this.currentPlayer.username = data.username;
              this.currentPlayer.userId = data.userId;
              //this.currentPlayer.avatarUrl = currentPlayerAvatarUrl;
              this.currentPlayer.avatarUrl = data.avatarUrl;

              this.$socket.emit('playerJoin', {
                username: data.username,
                userId: data.userId,
                roomId: data.roomId
              });
            }
          } 

          let inGame = false;
          for(let ii = 0; ii < this.playersInRoom.length; ++ii) {
            if(this.playersInRoom[ii].username == data.username)
              inGame = true;
          }

          if(!inGame && data.username !== undefined && data.roomId !== undefined) {
            app.playersInRoom.push({
              username: data.username,
              avatarUrl: data.avatarUrl,
              ready: data.ready === true ? 'true' : 'false'
            });
          }
        },
        // backend should trigger this event rather than frontend (look at backend)
        playerLeave: function(data) {
          console.log(`received from server playerLeave:  
            ${data.username}    ${data.roomId}`);

          this.messageLog.unshift({
            message: `${data.username} leaves the room`,
            time: moment().format('h:mm:ss a')
          });

          this.playersInRoom = this.playersInRoom.filter(function(player) {
            if(player.username == data.username) {
              console.log(`Removed player in playerlist ${player.username}`);
              return false;
            } else {
              return true;
            }
          });
        },
        playerReady: function(data) {
          this.playersInRoom.forEach(function(player) {
            if(player.username == data.username) {
              player.ready = 'true';
            }
          });
          if(data.username != this.currentPlayer.username) {
            this.messageLog.unshift({
              message: `${data.username} is ready`,
              time: moment().format('h:mm:ss a')
            });
          }
        },
        answer: function(data) {
          console.log(`${data.username}   ${data.useranswer}`);
          if(data.username != this.currentPlayer.username) {
            this.messageLog.unshift({
              message: `${data.username} has submitted answer`,
              time: moment().format('h:mm:ss a')
            });
          }
          
          //if(data.roomId == this.roomId) {
            if(data.username != this.currentPlayer.username) {
              this.submittedAnswers.push({
                useranswer: data.useranswer
              });

              let submittedUserAvatar = '';
              this.playersInRoom.forEach(function(player) {
                if(player.username == data.username) {
                  submittedUserAvatar = player.avatarUrl;
                }
              });
              this.submittedUsers.push({
                username: data.username, 
                avatarUrl: submittedUserAvatar
              });

              this.submittedCards.push({
                username: data.username,
                useranswer: data.useranswer,
                avatarUrl: submittedUserAvatar  
              });              
            }
          //}
        },
        playerOut: function(data) {
          console.log(`playerOut received from server  ${data}`);
          if(data.username == this.currentPlayer.username) {
            this.messageLog.unshift({
              message: `You are out of round`,
              time: moment().format('h:mm:ss a')
            });
          } else {
            this.messageLog.unshift({
              message: `${data.username} is out of round`,
              time: moment().format('h:mm:ss a')
            });
          }
          
          if(this.roomId == data.roomId) {
            if(data.username == this.currentPlayer.username) {
              // if the username sent by backend is same as current client's 
              // username, change game components related to 'out of round'
              console.log(`Received matched username ${data.username}`);
              this.currentGameMode = 'out of round';
            } 
          }
        },
        guessMatch: function(data) {
          if(this.roomId == data.roomId) {
            let username = data.username;
            let useranswer = data.useranswer;

            this.messageLog.unshift({
              message: `A guess is matched: ${data.username} => ${data.useranswer}`,
              time: moment().format('h:mm:ss a') 
            });

            this.submittedCards = this.submittedCards.filter(function(card) {
              if((card.username !== username) || (card.useranswer !== useranswer)) {
                return true;
              } else {
                return false;
              }
            });
            
            this.submittedUsers = this.submittedUsers.filter(function(card) {
              return card.username !== username;
            });

            let hasRemoved = false;
            this.submittedAnswers = this.submittedAnswers.filter(function(card) {
              if(!hasRemoved && card.useranswer === useranswer) {
                hasRemoved = true;
                return false;
              } else {
                return true;
              }
            });
          }
        },
        playerTurn: function(data) {
          console.log(`Received from server playerTurn 
            ${data.roomId}  ${data.username}`);
          if(data.username == this.currentPlayer.username) {
            this.messageLog.unshift({
              message: `Currently it is your turn to guess a match`,
              time: moment().format('h:mm:ss a')
            });
          } else {
            this.messageLog.unshift({
              message: `Currently it is ${data.username}'s turn to guess a match`,
              time: moment().format('h:mm:ss a')
            });
          }
          
          // if(data.userId == this.currentPlayer.userId)
          if(data.username == this.currentPlayer.username) {
            // When backend pick a user to guess, if data.username
            // is equal to current client's username
            // change the game components related to 'guess'
            this.currentGameMode = 'guess';
          } else {
            this.currentGameMode = 'observe guess';
          }
        },
        newRound: function(data) {
          console.log(`Received from server playerTurn ${data}`);
          this.messageLog.unshift({
            message: `An new round is started, wait for all the players ready`,
            time: moment().format('h:mm:ss a')
          });
          // When some signals are received, change the game components 
          // related to 'answers'
          this.currentGameMode = 'wait';
        },
        // For those four "game state" events, should implement components 
        // for prompting current player that game state is changed
        gameStateWait: function() {
          console.log(`Received from server gameStateWait`);
          // do something that let current player know game state changed
        },
        gameStateAnswer: function(data) {
          console.log(`Received from server gameStateAnswer ${data.question}`);
          this.messageLog.unshift({
            message: `Currently the game is in the answering stage`,
            time: moment().format('h:mm:ss a')
          });
          // do something that let current player know game state changed
          this.currentGameMode = 'answer';
          this.currentCard = data.question;
        },
        gameStateGuess: function(data) {
          console.log(`Received from server gameStateGuess ${data.username}`);
          this.messageLog.unshift({
            message: `Currently the game is in the guessing stage`,
            time: moment().format('h:mm:ss a') 
          });
          if(data.username == this.currentPlayer.username) {
            this.currentGameMode = 'guess';
            this.messageLog.unshift({
              message: `You got a turn to guess a match`,
              time: moment().format('h:mm:ss a')
            });
          } else {
            this.currentGameMode = 'observe guess';
            this.messageLog.unshift({
              message: `${data.username} got a turn to guess a match`,
              time: moment().format('h:mm:ss a')
            });
          }
        },
        gameStateEnd: function() {
          console.log(`Received from server gameStateEnd`);
          this.messageLog.unshift({
            message: `The current round is end`,
            time: moment().format('h:mm:ss a')
          });

          this.$socket.emit('newRound', {
            roomId: this.roomId
          });

          this.playersInRoom.forEach(function(player) {
            player.ready = 'false';
          });
          this.submittedAnswers = [];
          this.submittedUsers = [];
          this.submittedCards = [];
          this.guessedResult = {
            username: '',
            useranswer: ''
          };

          this.currentGameMode = 'wait';
        },
        playerStateReady: function(data) {
          console.log(`Received from server playerStateReady ${data.username}`);
          // do something that updates player's info
        }
      }
    }); 

    EventBus.$on('guessed-username', function(username) {
      console.log(`received user selected name ${username.username}`);
      app.guessedResult.username = username.username;
    });

    EventBus.$on('guessed-answer', function(answer) {
      console.log(`received user selected name ${answer.useranswer}`);
      app.guessedResult.useranswer = answer.useranswer;
    });
  </script>
</html>